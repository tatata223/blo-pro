#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะทะฐะฟััะบะฐ ะฑัะบะตะฝะดะฐ ะธ ััะพะฝัะตะฝะดะฐ ะพะดะฝะพะน ะบะพะผะฐะฝะดะพะน

echo "๐ ะะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั ะะฐะผะตัะบะธ..."
echo ""

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# ะคัะฝะบัะธั ะดะปั ะพัะธััะบะธ ะฟัะธ ะฒััะพะดะต
cleanup() {
    echo ""
    echo -e "${YELLOW}ะััะฐะฝะพะฒะบะฐ ัะตัะฒะตัะฐ...${NC}"
    kill $BACKEND_PID 2>/dev/null
    exit
}

# ะะฑัะฐะฑะพัะบะฐ ัะธะณะฝะฐะปะพะฒ ะดะปั ะบะพััะตะบัะฝะพะณะพ ะทะฐะฒะตััะตะฝะธั
trap cleanup SIGINT SIGTERM

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั Python 3
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}โ Python 3 ะฝะต ะฝะฐะนะดะตะฝ. ะฃััะฐะฝะพะฒะธัะต Python 3.${NC}"
    exit 1
fi

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั Node.js
if ! command -v node &> /dev/null; then
    echo -e "${RED}โ Node.js ะฝะต ะฝะฐะนะดะตะฝ. ะฃััะฐะฝะพะฒะธัะต Node.js.${NC}"
    exit 1
fi

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั npm
if ! command -v npm &> /dev/null; then
    echo -e "${RED}โ npm ะฝะต ะฝะฐะนะดะตะฝ. ะฃััะฐะฝะพะฒะธัะต npm.${NC}"
    exit 1
fi

# ะะตัะตัะพะด ะฒ ะดะธัะตะบัะพัะธั ะฑัะบะตะฝะดะฐ
cd backend || exit 1

# ะัะพะฒะตัะบะฐ ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
if [ ! -d "venv" ]; then
    echo -e "${YELLOW}๐ฆ ะกะพะทะดะฐะฝะธะต ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั...${NC}"
    python3 -m venv venv
fi

# ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
echo -e "${YELLOW}๐ง ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั...${NC}"
source venv/bin/activate

# ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน ะฑัะบะตะฝะดะฐ
echo -e "${YELLOW}๐ฅ ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน ะฑัะบะตะฝะดะฐ...${NC}"
if ! python3 -c "import django" 2>/dev/null; then
    echo -e "${YELLOW}๐ฅ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน ะฑัะบะตะฝะดะฐ...${NC}"
    pip3 install -r requirements.txt
    if [ $? -ne 0 ]; then
        echo -e "${RED}โ ะัะธะฑะบะฐ ัััะฐะฝะพะฒะบะธ ะทะฐะฒะธัะธะผะพััะตะน${NC}"
        exit 1
    fi
    # ะัะพะฒะตััะตะผ ะตัะต ัะฐะท ะฟะพัะปะต ัััะฐะฝะพะฒะบะธ
    if ! python3 -c "import django" 2>/dev/null; then
        echo -e "${RED}โ Django ะฝะต ัััะฐะฝะพะฒะปะตะฝ ะฟะพัะปะต ะฟะพะฟััะบะธ ัััะฐะฝะพะฒะบะธ${NC}"
        exit 1
    fi
fi

# ะกะพะทะดะฐะฝะธะต ะผะธะณัะฐัะธะน ะดะปั ะฒัะตั ะฟัะธะปะพะถะตะฝะธะน
echo -e "${YELLOW}๐ ะกะพะทะดะฐะฝะธะต ะผะธะณัะฐัะธะน...${NC}"
python3 manage.py makemigrations 2>&1 | grep -v "No changes detected" || true

# ะัะฟะพะปะฝะตะฝะธะต ะผะธะณัะฐัะธะน
echo -e "${YELLOW}๐๏ธ  ะัะฟะพะปะฝะตะฝะธะต ะผะธะณัะฐัะธะน...${NC}"
python3 manage.py migrate --noinput
if [ $? -ne 0 ]; then
    echo -e "${YELLOW}โ๏ธ  ะะพะฟััะบะฐ ะธัะฟัะฐะฒะธัั ะผะธะณัะฐัะธะธ...${NC}"
    # ะฃะดะฐะปัะตะผ ะฟัะพะฑะปะตะผะฝัั ะฑะฐะทั ะดะฐะฝะฝัั ะธ ัะพะทะดะฐะตะผ ะทะฐะฝะพะฒะพ
    if [ -f "db.sqlite3" ]; then
        echo -e "${YELLOW}๐๏ธ  ะฃะดะฐะปะตะฝะธะต ััะฐัะพะน ะฑะฐะทั ะดะฐะฝะฝัั...${NC}"
        rm -f db.sqlite3
    fi
    python3 manage.py makemigrations
    python3 manage.py migrate --noinput
    if [ $? -ne 0 ]; then
        echo -e "${RED}โ ะัะธัะธัะตัะบะฐั ะพัะธะฑะบะฐ ะผะธะณัะฐัะธะน${NC}"
        exit 1
    fi
fi

# ะกะพะทะดะฐะฝะธะต ััะฟะตัะฟะพะปัะทะพะฒะฐัะตะปั (ะตัะปะธ ะฝะต ัััะตััะฒัะตั)
echo -e "${YELLOW}๐ค ะัะพะฒะตัะบะฐ ััะฟะตัะฟะพะปัะทะพะฒะฐัะตะปั...${NC}"
python3 manage.py create_superuser 2>/dev/null || echo "ะกัะฟะตัะฟะพะปัะทะพะฒะฐัะตะปั ัะถะต ัััะตััะฒัะตั ะธะปะธ ะบะพะผะฐะฝะดะฐ ะฝะตะดะพัััะฟะฝะฐ"

# ะะฝะธัะธะฐะปะธะทะฐัะธั ัะฐะฑะปะพะฝะพะฒ (ะฒัะตะณะดะฐ ะพะฑะฝะพะฒะปัะตะผ)
echo -e "${YELLOW}๐ ะะฝะธัะธะฐะปะธะทะฐัะธั ัะฐะฑะปะพะฝะพะฒ...${NC}"
python3 manage.py init_templates 2>/dev/null || echo "ะจะฐะฑะปะพะฝั ะพะฑะฝะพะฒะปะตะฝั"

# ะะพะทะฒัะฐั ะฒ ะบะพัะฝะตะฒัั ะดะธัะตะบัะพัะธั
cd ..

# ะะตัะตัะพะด ะฒ ะดะธัะตะบัะพัะธั ััะพะฝัะตะฝะดะฐ
cd frontend || exit 1

# ะัะพะฒะตัะบะฐ node_modules
if [ ! -d "node_modules" ]; then
    echo -e "${YELLOW}๐ฅ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน ััะพะฝัะตะฝะดะฐ...${NC}"
    npm install
fi

# ะกะฑะพัะบะฐ React ะฟัะธะปะพะถะตะฝะธั ะดะปั production (ะฒัะตะณะดะฐ ะฟะตัะตัะพะฑะธัะฐะตะผ)
echo -e "${YELLOW}๐จ ะะตัะตัะฑะพัะบะฐ React ะฟัะธะปะพะถะตะฝะธั...${NC}"
rm -rf build
npm run build
if [ $? -ne 0 ]; then
    echo -e "${RED}โ ะัะธะฑะบะฐ ัะฑะพัะบะธ React ะฟัะธะปะพะถะตะฝะธั${NC}"
    exit 1
fi
echo -e "${GREEN}โ React ะฟัะธะปะพะถะตะฝะธะต ััะฟะตัะฝะพ ัะพะฑัะฐะฝะพ${NC}"

# ะะพะทะฒัะฐั ะฒ ะบะพัะฝะตะฒัั ะดะธัะตะบัะพัะธั
cd ..

# ะะตัะตัะพะด ะพะฑัะฐัะฝะพ ะฒ backend ะดะปั ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ
cd backend || exit 1
source venv/bin/activate

# ะะฐะฟััะบ Django ัะตัะฒะตัะฐ (ะปะพะณะธ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ ะฒ ัะตัะผะธะฝะฐะปะต)
echo ""
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โ ะะฐะฟััะบ Django ัะตัะฒะตัะฐ ะฝะฐ http://localhost:8000${NC}"
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""
# ะะพะปััะฐะตะผ ะปะพะบะฐะปัะฝัะน IP ะฐะดัะตั
LOCAL_IP=$(ipconfig getifaddr en0 2>/dev/null || ifconfig | grep "inet " | grep -v 127.0.0.1 | awk '{print $2}' | head -1)
if [ -z "$LOCAL_IP" ]; then
    LOCAL_IP="192.168.1.1"  # Fallback
fi

echo -e "๐ ะัะธะปะพะถะตะฝะธะต ะดะพัััะฟะฝะพ ะฝะฐ: ${GREEN}http://localhost:8000${NC}"
echo -e "๐ ะัะธะปะพะถะตะฝะธะต ะดะพัััะฟะฝะพ ะฒ ัะตัะธ: ${GREEN}http://${LOCAL_IP}:8000${NC}"
echo -e "๐ API ะดะพัััะฟะตะฝ ะฝะฐ: ${GREEN}http://localhost:8000/api/${NC}"
echo -e "๐ ะะดะผะธะฝ-ะฟะฐะฝะตะปั: ${GREEN}http://localhost:8000/admin/${NC}"
echo -e "${YELLOW}๐ก ะะปั ะดะพัััะฟะฐ ั ัะตะปะตัะพะฝะฐ ะธัะฟะพะปัะทัะนัะต: http://${LOCAL_IP}:8000${NC}"
echo ""
echo -e "${YELLOW}ะะพะณะธ ัะตัะฒะตัะฐ ะพัะพะฑัะฐะถะฐัััั ะฝะธะถะต ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ${NC}"
echo -e "${YELLOW}ะะฐะถะผะธัะต Ctrl+C ะดะปั ะพััะฐะฝะพะฒะบะธ ัะตัะฒะตัะฐ${NC}"
echo ""
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# ะะฐะฟััะบ ัะตัะฒะตัะฐ ะฝะฐ 0.0.0.0 ะดะปั ะดะพัััะฟะฐ ั ะดััะณะธั ััััะพะนััะฒ ะฒ ะปะพะบะฐะปัะฝะพะน ัะตัะธ
python3 manage.py runserver 0.0.0.0:8000
